# Мониторинг и логирование для MrBets.ai

## Общая архитектура

В проекте используется следующая архитектура мониторинга и логирования:

```
┌─────────────┐     ┌──────────────┐     ┌───────────────┐
│ Приложения  │────▶│ Prometheus   │────▶│ Grafana       │
│ с метриками │     │ (сбор метрик)│     │ (визуализация)│
└─────────────┘     └──────────────┘     └───────────────┘
       │
       │                ┌───────────────┐
       └───────────────▶│ Logtail       │
                        │ (логирование) │
                        └───────────────┘
```

## Система мониторинга (Prometheus + Grafana)

### Что мониторится:

1. **Frontend (Next.js)**
   - Доступность сервиса
   - Время ответа API
   - Использование памяти
   - Загрузка CPU

2. **Backend (FastAPI)**
   - Время обработки запросов
   - Количество запросов (по эндпоинтам)
   - Ошибки API
   - Использование CPU и памяти

3. **Worker**
   - Количество обработанных задач
   - Ошибки при обработке
   - Время обработки задач

4. **Redis**
   - Использование памяти
   - Количество соединений
   - Количество операций (чтение/запись)

### Доступ к мониторингу:

- **Prometheus**: http://localhost:9090
  - Используется для хранения временных рядов метрик
  - Выполнения PromQL запросов
  
- **Grafana**: http://localhost:3001 
  - Логин: admin
  - Пароль: admin (или заданный в .env)
  - Дашборды находятся в MrBets/

### Алерты

В текущей реализации настроены базовые алерты:
- Недоступность сервисов
- Высокое использование CPU (>80%)
- Высокое использование памяти (>80%)

## Система логирования (Logtail)

Logtail используется для централизованного сбора и анализа логов со всех сервисов.

### Настройка:

1. Создайте аккаунт на [Logtail](https://betterstack.com/logtail)
2. Получите `LOGTAIL_SOURCE_TOKEN` и добавьте его в `.env`
3. Логи автоматически отправляются в Logtail

### Типы логов:

- **INFO**: Стандартные операции (запуск сервисов, успешные запросы)
- **WARNING**: Потенциальные проблемы (медленные запросы, повторные попытки)
- **ERROR**: Ошибки (сбои в работе API, проблемы с подключением)
- **CRITICAL**: Критические ошибки (сбой сервиса, потеря данных)

### Поиск в логах:

В Logtail доступен полнотекстовый поиск по логам с использованием фильтров:
- По сервису: `service:backend-api`
- По уровню: `level:ERROR`
- По содержимому: `message:*prediction*`
- По времени: последние 24 часа, 7 дней и т.д.

## Настройка в локальной среде

### Запуск мониторинга:

```bash
# Запуск всего стека
docker-compose up -d

# Запуск только мониторинга
docker-compose up -d prometheus grafana
```

### Настройка логирования:

В локальной среде логи отображаются в консоли и отправляются в Logtail, если задан токен.

### Проверка метрик:

```bash
# Проверка метрик frontend
curl http://localhost:3000/api/metrics

# Проверка метрик backend
curl http://localhost:8000/metrics
```

## Рекомендации по отладке

1. **Проверка состояния сервисов**:
   ```bash
   curl http://localhost:3000/api/health
   curl http://localhost:8000/health
   ```

2. **Просмотр логов**:
   ```bash
   # Вывод логов конкретного сервиса
   docker-compose logs frontend
   docker-compose logs backend
   
   # Слежение за логами в реальном времени
   docker-compose logs -f backend
   ```

3. **Проверка метрик в Prometheus**:
   - Откройте http://localhost:9090/graph
   - Используйте запросы типа `up` для проверки доступности сервисов

4. **Доступ к дашбордам Grafana**:
   - Откройте http://localhost:3001
   - Авторизуйтесь с помощью учетных данных
   - Откройте дашборд MrBets Dashboard 